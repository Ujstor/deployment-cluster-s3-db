- name: Cluster config | ssl, dns, rename drives
  hosts: backup
  become: true
  ignore_unreachable: true
  vars:
    dns_mappings:
      - hostname: "minio1.ujstor.com"
        ip_address: "10.0.3.2"
      - hostname: "minio2.ujstor.com"
        ip_address: "10.0.3.3"
      - hostname: "minio3.ujstor.com"
        ip_address: "10.0.3.4"
  tasks:
    - name: Download certgen
      ansible.builtin.get_url:
        url: "https://github.com/minio/certgen/releases/download/v1.2.1/certgen-linux-amd64"
        dest: "ssl/certgen-linux-amd64"
        mode: "u+x"
      become: true
      vars:
        ansible_become_password: "root"
      delegate_to: localhost

    - name: Generate SSL certificates
      args:
        chdir: "ssl/"
      ansible.builtin.shell: "./certgen-linux-amd64 -host '{{ dns_hosts }}'"
      become: true
      vars:
        dns_hosts: "{{ dns_mappings | map(attribute='ip_address') | join(',') }},{{ dns_mappings | map(attribute='hostname') | join(',') }}"
        ansible_become_password: "root"
      delegate_to: localhost

    - name: Set permissions for private key
      ansible.builtin.file:
        path: ssl/private.key
        mode: "0777"
        owner: "root"
        group: "root"
      become: true
      vars:
        ansible_become_password: "root"
      delegate_to: localhost

    - name: Check if cert directory exists
      stat:
        path: /etc/minio/ssl/CAs
      register: dir_check

    - name: Create cert directory
      file:
        path: /etc/minio/ssl/CAs
        state: directory
      when: not dir_check.stat.exists

    - name: Copy openssl crt
      copy:
        src: ssl/public.crt
        dest: /etc/minio/ssl

    - name: Copy openssl crt to CAs
      copy:
        src: ssl/public.crt
        dest: /etc/minio/ssl/CAs

    - name: Copy openssl key
      copy:
        src: ssl/private.key
        dest: /etc/minio/ssl

    - name: Configure DNS mappings
      lineinfile:
        path: /etc/hosts
        line: "{{ item.ip_address }} {{ item.hostname }}"
        state: present
      loop: "{{ dns_mappings }}"

    - name: Copy mount volume rename script
      copy:
        src: scripts/rename_volumes.sh
        dest: /tmp/rename_volumes.sh
        mode: +x

    - name: Execute the script
      shell: /tmp/rename_volumes.sh

    - name: Reboot server
      shell: "reboot"
      async: 0
      poll: 0

    - name: Wait for servers to come back online
      ansible.builtin.wait_for_connection:
        delay: 30
        timeout: 300 

# curl -LO https://github.com/minio/certgen/releases/download/v1.2.1/certgen-linux-amd64
# ./certgen-linux-amd64 -host "10.0.3.2, 10.0.3.3, 10.0.3.4, minio1.ujstor.com, minio2.ujstor.com, minio3.ujstor.com"
