---
- import_playbook: unique_templates_config/playbook_dns_backup_lb.yml

- name: Configure Nginx as Load Balancer for MinIO cluster
  hosts: nginx-minio-lb
  become: true
  roles:
    - role: common

  vars:
    minio_servers:
      - 91.107.208.20
      - 65.109.9.72
      - 5.75.139.83
    minio_port: 9091
    console_port: 9092
    console_domain: minio-console.ujstor.com
    minio_domain: minio.ujstor.com
    crt_path: /root/.minio/certs/minio.ujstor.com.crt
    crt_private_key_path: /root/.minio/certs/minio.ujstor.com.key


  tasks:
    - name: Check if cert directory exists
      stat:
        path: ${HOME}/.minio/certs
      register: dir_check

    - name: Create cert directory
      file:
        path: ${HOME}/.minio/certs
        state: directory
      when: not dir_check.stat.exists

    - name: Copy openssl crt
      copy:
        src: unique_templates_config/scripts/local-openssl/minio.ujstor.com.crt
        dest: ${HOME}/.minio/certs

    - name: Copy openssl key
      copy:
        src: unique_templates_config/scripts/local-openssl/minio.ujstor.com.key
        dest: ${HOME}/.minio/certs

    - name: Install Nginx
      include_role:
        name: nginx

    - name: Create NGINX configuration directory
      file:
        path: /etc/nginx/conf.d
        state: directory
        mode: 0755
        owner: root
        group: root

    - name: Create nginx group
      group:
        name: nginx
        state: present

    - name: Create nginx system user
      user:
        name: nginx
        system: yes
        createhome: no
        shell: /bin/false
        group: nginx
        state: present

    - name: Nginx configuration file
      template:
        src: unique_templates_config/minio_lb/nginx.conf.j2
        dest: /etc/nginx/nginx.conf
      notify: Restart Nginx

    - name: Allow http, UI and S3 API ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
      loop:
        - 80
        - 443
        - 9091
        - 9092

  handlers:
    - name: Restart Nginx
      ansible.builtin.systemd_service:
        name: nginx.service
        state: restarted

# sudo adduser --system --no-create-home --disabled-login --group nginx
